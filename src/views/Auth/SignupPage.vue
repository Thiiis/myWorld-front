<template>
  <div
    class="min-vh-100 d-flex align-items-center justify-content-center p-4"
    style="
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
    "
  >
    <div
      class="position-fixed top-0 start-0 w-100 h-100 overflow-hidden"
      style="pointer-events: none"
    >
      </div>

    <div class="w-100 position-relative" style="max-width: 500px; z-index: 10">
      <button
        @click="$emit('back-to-landing')"
        class="btn btn-outline-primary mb-4 d-flex align-items-center gap-2 px-4 py-2 pixel-font"
      >
        <i class="bi bi-arrow-left"></i>
        ëŒì•„ê°€ê¸°
      </button>
      <div class="text-center mb-4">
        </div>

      <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
        <div
          class="card-body p-4"
          style="
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
          "
        >
          <div class="text-center mb-4">
            <h2
              class="h4 pixel-font text-primary d-flex align-items-center justify-content-center gap-2"
              style="letter-spacing: 1px"
            >
              <i class="bi bi-person-plus"></i>
              íšŒì›ê°€ì…
              <i class="bi bi-person-plus"></i>
            </h2>
            <hr class="border-primary opacity-25 my-3" />
          </div>

          <form
            @submit.prevent="handleSignup"
            class="mx-auto"
            style="max-width: 400px"
            novalidate
          >
            <div class="mb-3">
              <label class="form-label pixel-font fw-bold text-dark"
                >â˜ï¸ ì•„ì´ë”” (ID)</label
              >
              <input
                type="text"
                class="form-control"
                v-model.trim="signupForm.account"
                :class="{ 'is-invalid': errors.account }"
                placeholder="ì˜ë¬¸, ìˆ«ì ì¡°í•© (4-20ì)"
              />
              <div v-if="errors.account" class="invalid-feedback">
                {{ errors.account }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label pixel-font fw-bold text-dark"
                >â˜ï¸ ë¹„ë°€ë²ˆí˜¸ (PASSWORD)</label
              >
              <input
                type="password"
                class="form-control"
                v-model.trim="signupForm.pwd"
                :class="{ 'is-invalid': errors.pwd }"
                placeholder="ì˜ë¬¸, ìˆ«ì ì¡°í•© (6ì ì´ìƒ)"
              />
              <div v-if="errors.pwd" class="invalid-feedback">
                {{ errors.pwd }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label pixel-font fw-bold text-dark"
                >â˜ï¸ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label
              >
              <input
                type="password"
                class="form-control"
                v-model.trim="signupForm.pwdConfirm"
                :class="{ 'is-invalid': errors.pwdConfirm }"
                placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
              />
              <div v-if="errors.pwdConfirm" class="invalid-feedback">
                {{ errors.pwdConfirm }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label pixel-font fw-bold text-dark"
                >â˜ï¸ ë‹‰ë„¤ì„ (NICKNAME)</label
              >
              <input
                type="text"
                class="form-control"
                v-model.trim="signupForm.nickname"
                :class="{ 'is-invalid': errors.nickname }"
                placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (2-10ì)"
              />
              <div v-if="errors.nickname" class="invalid-feedback">
                {{ errors.nickname }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label pixel-font fw-bold text-dark"
                >â˜ï¸ ì´ë©”ì¼ (EMAIL)</label
              >
              <input
                type="email"
                class="form-control"
                v-model.trim="signupForm.email"
                :class="{ 'is-invalid': errors.email }"
                placeholder="example@email.com"
              />
              <div v-if="errors.email" class="invalid-feedback">
                {{ errors.email }}
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label pixel-font fw-bold text-dark"
                >â˜ï¸ ìƒë…„ì›”ì¼ (BIRTHDATE)</label
              >
              <input
                type="text"
                class="form-control"
                v-model.trim="signupForm.birthdate"
                :class="{ 'is-invalid': errors.birthdate }"
                placeholder="1998-12-26"
              />
              <div v-if="errors.birthdate" class="invalid-feedback">
                {{ errors.birthdate }}
              </div>
            </div>

            <button
              type="submit"
              class="btn btn-primary w-100"
              style="
                font-size: 1rem;
                letter-spacing: 1px;
                box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
              "
            >
              â˜ï¸ íšŒì›ê°€ì… ì™„ë£Œ â˜ï¸
            </button>
            <button
              type="button"
              class="btn btn-white w-100 mt-2"
              @click="$router.push('/login')"
              style="
                font-size: 1rem;
                letter-spacing: 1px;
                border-width: 2px;
                background-color: rgba(59, 130, 246, 0.1);
              "
            >
              ğŸ’™ ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”? ë¡œê·¸ì¸ ğŸ’™
            </button>
          </form>
          <div class="mt-4 text-center">
            <p
              class="small english-pixel text-muted"
              style="letter-spacing: 0.5px"
            >
              â˜ï¸ CREATE YOUR SKY WORLD â˜ï¸
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import memberApi from "@/apis/memberApi"; // API ëª¨ë“ˆ ì„í¬íŠ¸
import { ref } from "vue";
import { useRouter } from "vue-router";

const router = useRouter();

const signupForm = ref({
  account: "",
  pwd: "",
  pwdConfirm: "",
  nickname: "",
  email: "",
  birthdate: "",
});

// âœ¨ ë³€ê²½ì  3: ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í•œ ë²ˆì— ê´€ë¦¬í•  ë°˜ì‘í˜• ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
const errors = ref({});

// âœ¨ ë³€ê²½ì  4: ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ì„ í¬í•¨í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
function validateForm() {
  // ì´ì „ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
  errors.value = {};

  // ê° í•„ë“œì— ëŒ€í•œ ì •ê·œì‹ íŒ¨í„´
  const accountPattern = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{4,20}$/;
  const pwdPattern = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/;
  const nicknamePattern = /^.{2,10}$/;
  const emailPattern =
    /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i;
  const birthdatePattern = /^\d{4}-\d{2}-\d{2}$/;

  // ìœ íš¨ì„± ê²€ì‚¬ ì‹œì‘
  if (!accountPattern.test(signupForm.value.account)) {
    errors.value.account = "ì•„ì´ë””ëŠ” 4~20ìì˜ ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.";
  }
  if (!pwdPattern.test(signupForm.value.pwd)) {
    errors.value.pwd = "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì˜ ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.";
  }
  if (signupForm.value.pwd !== signupForm.value.pwdConfirm) {
    errors.value.pwdConfirm = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  }
  if (!nicknamePattern.test(signupForm.value.nickname)) {
    errors.value.nickname = "ë‹‰ë„¤ì„ì€ 2ì ì´ìƒ 10ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
  }
  if (!emailPattern.test(signupForm.value.email)) {
    errors.value.email = "ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
  }
  if (!birthdatePattern.test(signupForm.value.birthdate)) {
    errors.value.birthdate = "ìƒë…„ì›”ì¼ì„ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.";
  }

  // errors ê°ì²´ì— í‚¤ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨
  return Object.keys(errors.value).length === 0;
}

async function handleSignup() {
  // âœ¨ ë³€ê²½ì  5: API ìš”ì²­ ì „ì— ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
  if (!validateForm()) {
    return; // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
  }

  try {
    const { pwdConfirm, ...dataToSend } = structuredClone(signupForm.value);

    const response = await memberApi.memberSignup(dataToSend);

    if (response.status === 200) {
      alert("íšŒì›ê°€ì…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      await router.push("/login");
    } else {
      alert(response.data.message || "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (error) {
    console.error(error);
    alert(error.response?.data?.message || "íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}
</script>

<style scoped>
/* CSSëŠ” ì´ì „ê³¼ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤. */
.pixel-font,
* {
  font-family: "DungGeunMo", sans-serif !important;
}

.english-pixel {
  font-family: "Upheaval", sans-serif !important;
}

.btn:hover {
  transform: scale(1.05);
}

.form-control:focus {
  border-color: var(--maintheme);
  box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
  transform: scale(1.02);
}

.alert {
  border-radius: 12px;
}

.card {
  backdrop-filter: blur(10px);
}

/* âœ¨ ì¶”ê°€: ì—ëŸ¬ ë©”ì‹œì§€ê°€ ì˜ ë³´ì´ë„ë¡ ìŠ¤íƒ€ì¼ì„ ì¶”ê°€í•©ë‹ˆë‹¤. */
.invalid-feedback {
  display: block;
  text-align: left;
  margin-top: 0.25rem;
  font-size: 0.8rem;
  color: #dc3545; /* Bootstrapì˜ danger color */
}
</style>